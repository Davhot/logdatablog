app:
  build: .
  command: sh docker/start.sh
  volumes:
    - .:/usr/src/app
    - ./config/database.yml.default:/usr/src/app/config/database.yml
    - ./bundle:/usr/local/bundle
    - ./public:/usr/share/nginx/html/logdatablog

    - /home/david/uploads/logdatablog:/usr/src/app/public/uploads
    - tmp:/usr/src/app/tmp
    - "/var/run/postgresql:/var/run/postgresql"
    - "../../dumps:/usr/src/app/dumps"
    - "../../logs:/usr/src/app/log"
  env_file:
    - database.env
    - api_secret.env
  environment:
    RAILS_ENV: "${RAILS_ENV}"
    REDIS_URL: redis://redis:6379/
  restart: always
  links:
    - redis
nginx:
  image: nginx
  links:
    - app
  volumes:
    - ./config/nginx.conf:/etc/nginx/nginx.conf
    - ./public:/usr/share/nginx/html/logdatablog

    - /home/david/uploads/logdatablog:/usr/share/nginx/html/logdatablog/uploads
    - "../../logs:/var/log"
    - /home/david/ssl_certificates/logdatablog:/usr/share/nginx/html/ssl_certificates/logdatablog
  ports:
    - "3000:3000"
  expose:
    - "3000"
  restart: always

redis:
  image: redis
  volumes:
    - ./config/redis.conf:/var/lib/redis.conf:ro
    - redis:/var/lib/redis/data
  ports:
    - "6379:6379"
  command: redis-server /var/lib/redis.conf
sidekiq:
  build: .
  volumes:
    - .:/usr/src/app
    - bundle:/usr/local/bundle
    - ./config/database.default.yml:/usr/src/app/config/database.yml
  links:
    - redis
  env_file:
    - database.env
  environment:
    - "RAILS_ENV=${RAILS_ENV}"
    - "REDIS_URL=redis://redis:6379/"
  command: bundle exec sidekiq -C config/sidekiq.yml
